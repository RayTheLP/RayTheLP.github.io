<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline - raythelp's Blog</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 頁首容器 -->
    <div id="headerContainer"></div>

    <!-- 主要內容 -->
    <main class="main-content">
        <!-- 側邊欄容器 -->
        <div id="sidebarContainer"></div>

        <!-- 右側內容區域 -->
        <section class="content">
            <div class="posts-timeline" id="postsTimeline">
                <!-- 時間線將由 JavaScript 動態生成 -->
            </div>
        </section>
    </main>

    <!-- 頁尾容器 -->
    <div id="footerContainer"></div>

    <!-- 載入設定檔 -->
    <script src="js/config.js"></script>
    <!-- 載入共用元件 -->
    <script src="js/common.js"></script>
    <!-- 載入文章導航功能 -->
    <script>
        // 全域變數存儲文章資料
        let allPosts = [];
        
        // 文章導航頁面專用功能
        document.addEventListener('DOMContentLoaded', function() {
            // 等待共用元件初始化完成
            setTimeout(() => {
                loadPostsTimeline();
            }, 200);
        });
        
        // 載入文章時間線
        async function loadPostsTimeline() {
            try {
                const response = await fetch('posts.json');
                const data = await response.json();
                allPosts = data.posts || [];
                
                // 按年份分組文章
                const postsByYear = groupPostsByYear(allPosts);
                
                // 渲染時間線
                renderTimeline(postsByYear);
                
                // 載入側邊欄的分類和標籤
                loadSidebarContent();
                
            } catch (error) {
                console.error('載入文章時發生錯誤:', error);
                document.getElementById('postsTimeline').innerHTML = '<div class="loading">載入文章失敗</div>';
            }
        }
        
        // 載入側邊欄內容
        function loadSidebarContent() {
            // 處理分類和標籤統計
            const categories = {};
            const tags = {};
            
            allPosts.forEach(post => {
                // 處理分類統計
                if (post.category) {
                    categories[post.category] = (categories[post.category] || 0) + 1;
                }
                
                // 處理標籤統計
                if (post.tags) {
                    post.tags.forEach(tag => {
                        tags[tag] = (tags[tag] || 0) + 1;
                    });
                }
            });
            
            // 渲染分類
            renderCategories(categories);
            
            // 渲染標籤
            renderTags(tags);
        }
        
        // 渲染分類側邊欄
        function renderCategories(categories) {
            const container = document.getElementById('categoryList');
            if (!container) {
                console.warn('找不到分類容器 #categoryList');
                return;
            }
            
            const categoriesList = Object.entries(categories)
                .map(([category, count]) => `
                    <li class="category-item" data-category="${category}">
                        <span class="category-name">${category}</span>
                        <span class="category-count">${count}</span>
                    </li>
                `).join('');
            
            container.innerHTML = categoriesList;
            
            // 添加點擊事件處理器
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', function() {
                    const category = this.dataset.category;
                    window.location.href = `index.html?category=${encodeURIComponent(category)}`;
                });
            });
        }
        
        // 渲染標籤雲側邊欄
        function renderTags(tags) {
            const container = document.getElementById('tagCloud');
            if (!container) {
                console.warn('找不到標籤容器 #tagCloud');
                return;
            }
            
            const tagsList = Object.entries(tags)
                .map(([tag, count]) => `
                    <span class="tag" data-tag="${tag}">
                        ${tag} <span class="tag-count">${count}</span>
                    </span>
                `).join('');
            
            container.innerHTML = tagsList;
            
            // 添加點擊事件處理器
            document.querySelectorAll('.tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const tagName = this.dataset.tag;
                    window.location.href = `index.html?tag=${encodeURIComponent(tagName)}`;
                });
            });
        }
        
        // 按年份分組文章
        function groupPostsByYear(posts) {
            const grouped = {};
            
            posts.forEach(post => {
                const year = post.date.split('-')[0];
                if (!grouped[year]) {
                    grouped[year] = [];
                }
                grouped[year].push(post);
            });
            
            // 按年份排序（最新的在前）
            return Object.keys(grouped)
                .sort((a, b) => b - a)
                .reduce((result, year) => {
                    result[year] = grouped[year].sort((a, b) => new Date(b.date) - new Date(a.date));
                    return result;
                }, {});
        }
        
        // 渲染時間線
        function renderTimeline(postsByYear) {
            const container = document.getElementById('postsTimeline');
            
            if (Object.keys(postsByYear).length === 0) {
                container.innerHTML = '<div class="loading">沒有找到文章</div>';
                return;
            }
            
            const timelineHTML = Object.entries(postsByYear).map(([year, posts]) => `
                <div class="timeline-year">
                    <h2 class="year-title">${year}</h2>
                    <div class="year-info">
                        <span class="year-dot"></span>
                        <span class="year-count">${posts.length} ${posts.length === 1 ? 'post' : 'posts'}</span>
                    </div>
                    <div class="year-posts">
                        ${posts.map(post => createTimelinePost(post)).join('')}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = timelineHTML;
            
            // 為文章添加點擊事件
            document.querySelectorAll('.timeline-post').forEach(post => {
                post.addEventListener('click', function() {
                    const postId = this.dataset.postId;
                    window.location.href = `post.html?id=${postId}`;
                });
            });
        }
        
        // 創建時間線文章項目
        function createTimelinePost(post) {
            const date = post.date.split('-').slice(1).join('-'); // 只顯示月-日
            const tags = post.tags ? post.tags.map(tag => `#${tag}`).join(' ') : '';
            
            return `
                <div class="timeline-post" data-post-id="${post.id}">
                    <div class="post-date">${date}</div>
                    <div class="post-content">
                        <h3 class="post-title">${post.title}</h3>
                        <div class="post-tags">${tags}</div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>